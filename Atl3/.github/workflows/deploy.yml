name: ğŸš€ DÃ©ploiement Flask Temporaire

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v3
      
    - name: ğŸ³ Configuration Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: ğŸ”¨ Construction de l'image Docker
      run: |
        echo "ğŸ”¨ Construction de l'image Docker..."
        docker build -t flask-temp-server .
        
    - name: ğŸš€ DÃ©marrage du serveur temporaire
      env:
        NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
      run: |
        echo "ğŸš€ DÃ©marrage du conteneur Docker..."
        docker run --rm \
          -e NGROK_TOKEN=$NGROK_TOKEN \
          -e REPO_URL=${{ github.server_url }}/${{ github.repository }} \
          --name flask-temp \
          flask-temp-server &
        
        # Attendre un peu pour que ngrok se lance
        sleep 10
        
        # RÃ©cupÃ©rer l'URL ngrok depuis les logs du conteneur
        echo "ğŸ” RÃ©cupÃ©ration de l'URL ngrok..."
        timeout 5 docker logs -f flask-temp 2>&1 | grep -E "https://.*\.ngrok\.io" | head -1 || echo "URL ngrok non trouvÃ©e dans les logs"
        
        # Attendre les 120 secondes complÃ¨tes
        echo "â° Attente de 120 secondes..."
        sleep 120
        
        echo "ğŸ›‘ ArrÃªt du conteneur..."
        docker stop flask-temp 2>/dev/null || true
        
    - name: ğŸ“Š RÃ©sumÃ© du dÃ©ploiement
      run: |
        echo "âœ… DÃ©ploiement terminÃ©"
        echo "ğŸ“Š Statistiques:"
        echo "   - Repository: ${{ github.repository }}"
        echo "   - Commit: ${{ github.sha }}"
        echo "   - Branch: ${{ github.ref_name }}"
        echo "   - DurÃ©e: 120 secondes"
